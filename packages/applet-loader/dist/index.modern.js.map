{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["import {\r\n  AppMetadata,\r\n  FrameworkConfiguration,\r\n  LoadableApp,\r\n  loadMicroApp,\r\n  MicroApp,\r\n  start,\r\n} from 'qiankun';\r\nimport Vue from 'vue';\r\nimport { VueConstructor } from 'vue/types/umd';\r\n\r\nexport interface AppletManifest extends AppMetadata {\r\n  propKeys?: string[];\r\n}\r\n\r\nexport interface StartOptions extends FrameworkConfiguration {}\r\n\r\nexport interface PropsData {\r\n  [field: string]: any;\r\n}\r\n\r\nexport type PropsDataGetter = (vueComponentInstance: VueConstructor<Vue>) => PropsData;\r\n\r\nexport class AppletLoader {\r\n  private _started = false;\r\n  private _appletList: AppletManifest[] = [];\r\n\r\n  private _addApplet(manifest: AppletManifest): void {\r\n    const name = manifest.name;\r\n    const idx = this._appletList.findIndex((it) => it.name === name);\r\n    if (idx === -1) {\r\n      this._appletList.push(manifest);\r\n      return;\r\n    }\r\n\r\n    this._appletList.splice(idx, 1, manifest);\r\n    console.warn(`[QianKunHelper] updated app manifest, name is '${name}'`);\r\n  }\r\n\r\n  private _findAppByName(name: string): AppletManifest | null {\r\n    return this._appletList.find((it) => it.name === name);\r\n  }\r\n\r\n  private getProps(keys: string[], db: PropsData): PropsData {\r\n    return keys.reduce((data, key) => {\r\n      data[key] = db[key];\r\n      return data;\r\n    }, {} as PropsData);\r\n  }\r\n\r\n  addApplet(...manifests: AppletManifest[]): void {\r\n    manifests.forEach((it) => this._addApplet(it));\r\n  }\r\n\r\n  findApplet(name: string): AppletManifest | null {\r\n    return this._findAppByName(name);\r\n  }\r\n\r\n  loadApplet(manifest: AppletManifest, containerId: string, props: PropsData): MicroApp {\r\n    const config = {\r\n      ...manifest,\r\n      container: containerId,\r\n      props: this.getProps(manifest.propKeys || [], props),\r\n    };\r\n\r\n    return loadMicroApp((config as any) as LoadableApp<PropsData>);\r\n  }\r\n\r\n  start(options?: StartOptions) {\r\n    if (this._started) {\r\n      return;\r\n    }\r\n\r\n    if (options) {\r\n      start(options);\r\n    } else {\r\n      start();\r\n    }\r\n    this._started = true;\r\n  }\r\n}\r\n\r\nexport const appletLoader = new AppletLoader();\r\n\r\nconst id = (function () {\r\n  let _i = 0;\r\n  return () => _i++;\r\n})();\r\n\r\nexport const makeAppletComponentCreator = (loader: AppletLoader, getPropsData: PropsDataGetter) => (\r\n  name: string,\r\n  options = { autoRemove: true, propsData: {} as PropsData },\r\n) => {\r\n  const containerId = `applet-container-${name}-${id()}`;\r\n  return Vue.extend({\r\n    data() {\r\n      return {\r\n        manifest: null as AppletManifest | null,\r\n        appInstance: null as MicroApp | null,\r\n        errorMessage: '',\r\n      };\r\n    },\r\n    computed: {\r\n      appName() {\r\n        return (this.manifest && this.manifest.name) || 'unname';\r\n      },\r\n    },\r\n    mounted() {\r\n      console.log('AppletComponent mounted. containerId =', containerId);\r\n\r\n      const vm = this;\r\n      const manifest = loader.findApplet(name);\r\n      if (manifest) {\r\n        let propsData = getPropsData(vm);\r\n        if (options && options.propsData && Object.keys(options.propsData).length > 0) {\r\n          propsData = {\r\n            ...propsData,\r\n            ...options.propsData,\r\n          };\r\n        }\r\n\r\n        this.appInstance = loader.loadApplet(manifest, `#${containerId}`, propsData);\r\n      } else {\r\n        this.errorMessage = `applet not found. lookup with name '${name}'`;\r\n      }\r\n    },\r\n    beforeDestroy() {\r\n      const autoRemove = options.autoRemove ?? true;\r\n\r\n      if (autoRemove && this.appInstance && typeof this.appInstance.unmount === 'function') {\r\n        console.log('AppletComponent unmounted. containerId =', containerId);\r\n        this.appInstance.unmount();\r\n      }\r\n    },\r\n    render(h) {\r\n      if (this.errorMessage !== '') {\r\n        return h('div', this.errorMessage);\r\n      }\r\n\r\n      return h('div', {\r\n        attrs: { id: containerId },\r\n        class: 'applet-container',\r\n      });\r\n    },\r\n  });\r\n};\r\n"],"names":["AppletLoader","constructor","this","_addApplet","manifest","name","idx","_appletList","findIndex","it","splice","console","warn","push","_findAppByName","find","getProps","keys","db","reduce","data","key","addApplet","manifests","forEach","findApplet","loadApplet","containerId","props","config","container","propKeys","loadMicroApp","start","options","_started","appletLoader","id","_i","makeAppletComponentCreator","loader","getPropsData","autoRemove","propsData","Vue","extend","appInstance","errorMessage","computed","appName","mounted","log","vm","Object","length","beforeDestroy","unmount","render","h","attrs","class"],"mappings":"0RAuBaA,EAAbC,cACUC,eAAW,EACXA,iBAAgC,GAEhCC,WAAWC,GACjB,MAAMC,EAAOD,EAASC,KAChBC,EAAMJ,KAAKK,YAAYC,UAAWC,GAAOA,EAAGJ,OAASA,IAC9C,IAATC,GAKJJ,KAAKK,YAAYG,OAAOJ,EAAK,EAAGF,GAChCO,QAAQC,uDAAuDP,OAL7DH,KAAKK,YAAYM,KAAKT,GAQlBU,eAAeT,GACrB,YAAYE,YAAYQ,KAAMN,GAAOA,EAAGJ,OAASA,GAG3CW,SAASC,EAAgBC,GAC/B,OAAOD,EAAKE,OAAO,CAACC,EAAMC,KACxBD,EAAKC,GAAOH,EAAGG,GACRD,GACN,IAGLE,aAAaC,GACXA,EAAUC,QAASf,GAAOP,KAAKC,WAAWM,IAG5CgB,WAAWpB,GACT,YAAYS,eAAeT,GAG7BqB,WAAWtB,EAA0BuB,EAAqBC,GACxD,MAAMC,OACDzB,GACH0B,UAAWH,EACXC,MAAO1B,KAAKc,SAASZ,EAAS2B,UAAY,GAAIH,KAGhD,OAAOI,EAAcH,GAGvBI,MAAMC,GACAhC,KAAKiC,WAILD,EACFD,EAAMC,GAEND,IAEF/B,KAAKiC,UAAW,IAIPC,MAAAA,EAAe,IAAIpC,EAE1BqC,EAAM,WACV,IAAIC,EAAK,EACT,MAAO,IAAMA,IAFH,GAKCC,EAA6B,CAACC,EAAsBC,IAAkC,CACjGpC,EACA6B,EAAU,CAAEQ,YAAY,EAAMC,UAAW,OAEzC,MAAMhB,sBAAkCtB,KAAQgC,MAChD,OAAOO,EAAIC,OAAO,CAChBzB,KAAI,KACK,CACLhB,SAAU,KACV0C,YAAa,KACbC,aAAc,KAGlBC,SAAU,CACRC,UACE,YAAa7C,UAAYF,KAAKE,SAASC,MAAS,WAGpD6C,UACEvC,QAAQwC,IAAI,yCAA0CxB,GAEtD,MAAMyB,EAAKlD,KACLE,EAAWoC,EAAOf,WAAWpB,GACnC,GAAID,EAAU,CACZ,IAAIuC,EAAYF,EAAaW,GACzBlB,GAAWA,EAAQS,WAAaU,OAAOpC,KAAKiB,EAAQS,WAAWW,OAAS,IAC1EX,OACKA,EACAT,EAAQS,YAIfzC,KAAK4C,YAAcN,EAAOd,WAAWtB,MAAcuB,IAAegB,QAElEzC,KAAK6C,oDAAsD1C,MAG/DkD,gCACqBrB,EAAQQ,iBAETxC,KAAK4C,aAAmD,wBAAxBA,YAAYU,UAC5D7C,QAAQwC,IAAI,2CAA4CxB,GACxDzB,KAAK4C,YAAYU,YAGrBC,OAAOC,GACL,OACSA,EAAE,MADe,KAAtBxD,KAAK6C,aACS7C,KAAK6C,aAGP,CACdY,MAAO,CAAEtB,GAAIV,GACbiC,MAAO"}