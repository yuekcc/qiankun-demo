{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["import {\r\n  AppMetadata,\r\n  FrameworkConfiguration,\r\n  LoadableApp,\r\n  loadMicroApp,\r\n  MicroApp,\r\n  start,\r\n} from 'qiankun';\r\nimport Vue from 'vue';\r\n\r\nexport interface AppManifest extends AppMetadata {\r\n  propKeys?: string[];\r\n}\r\n\r\nexport interface PropDataSet {\r\n  [field: string]: any;\r\n}\r\n\r\nexport class MicroAppLoader {\r\n  private _started = false;\r\n  private _appList: AppManifest[] = [];\r\n\r\n  /**\r\n   * 启动\r\n   */\r\n  start(qiankunStartOptions: FrameworkConfiguration | null = null) {\r\n    if (this._started) {\r\n      return;\r\n    }\r\n\r\n    if (qiankunStartOptions) {\r\n      start(qiankunStartOptions);\r\n    } else {\r\n      start();\r\n    }\r\n    this._started = true;\r\n  }\r\n\r\n  private _addApp(manifest: AppManifest): void {\r\n    const name = manifest.name;\r\n    const idx = this._appList.findIndex((it) => it.name === name);\r\n    if (idx === -1) {\r\n      this._appList.push(manifest);\r\n      return;\r\n    }\r\n\r\n    this._appList.splice(idx, 1, manifest);\r\n    console.warn(`[QianKunHelper] updated app manifest, name is '${name}'`);\r\n  }\r\n\r\n  /**\r\n   * 注册一个应用\r\n   * @param manifests 应用注册数据\r\n   */\r\n  addApp(...manifests: AppManifest[]): void {\r\n    manifests.forEach((it) => this._addApp(it));\r\n  }\r\n\r\n  private _findAppByName(name: string): AppManifest | null {\r\n    return this._appList.find((it) => it.name === name);\r\n  }\r\n\r\n  private getProps(keys: string[], db: Record<string, any>): Record<string, any> {\r\n    return keys.reduce((data, key) => {\r\n      data[key] = db[key];\r\n      return data;\r\n    }, {} as Record<string, any>);\r\n  }\r\n\r\n  /**\r\n   * 按名称查找一个应用\r\n   * @param name 应用名称\r\n   */\r\n  findApp(name: string): AppManifest | null {\r\n    return this._findAppByName(name);\r\n  }\r\n\r\n  /**\r\n   * 加载应用到指定容器\r\n   * @param manifest 应用注册信息\r\n   * @param containerId 容器 ID（如 #app）\r\n   * @param propDb 应用启动参数\r\n   */\r\n  loadApp(manifest: AppManifest, containerId: string, propDb: PropDataSet): MicroApp {\r\n    const config = {\r\n      ...manifest,\r\n      container: containerId,\r\n      props: this.getProps(manifest.propKeys || [], propDb),\r\n    };\r\n\r\n    return loadMicroApp((config as any) as LoadableApp<PropDataSet>);\r\n  }\r\n}\r\n\r\nexport const microAppLoader = new MicroAppLoader();\r\n\r\n/**\r\n * 创建一个 App 容器组件（Vue 组件）\r\n *\r\n * 该组件会自动在 mounted 后自动挂载应用\r\n *\r\n * @param loader QianKunHelper 实例\r\n * @param getPropDataSet 应用启动参数数据仓库 getter\r\n */\r\nexport const makeAppComponentCreator = (\r\n  loader: MicroAppLoader,\r\n  getPropDataSet: () => PropDataSet,\r\n) => (name: string, opt = { autoRemove: true }) => {\r\n  const containerId = `app-container-${name}`;\r\n  return Vue.extend({\r\n    data() {\r\n      return {\r\n        manifest: null as AppManifest | null,\r\n        appInstance: null as MicroApp | null,\r\n        errorMessage: '',\r\n      };\r\n    },\r\n    computed: {\r\n      appName() {\r\n        return (this.manifest && this.manifest.name) || 'unname';\r\n      },\r\n    },\r\n    mounted() {\r\n      console.log('MicroAppComponent mounted. containerId =', containerId);\r\n      const app = loader.findApp(name);\r\n      if (app) {\r\n        const propDb = getPropDataSet();\r\n        this.appInstance = loader.loadApp(app, `#${containerId}`, propDb);\r\n      } else {\r\n        this.errorMessage = 'app not found, name = ' + name;\r\n      }\r\n    },\r\n    beforeDestroy() {\r\n      const autoRemove = opt.autoRemove ?? true;\r\n\r\n      if (autoRemove && this.appInstance && typeof this.appInstance.unmount === 'function') {\r\n        this.appInstance.unmount();\r\n      }\r\n    },\r\n    render(h) {\r\n      if (this.errorMessage !== '') {\r\n        return h('div', this.errorMessage);\r\n      }\r\n\r\n      return h('div', {\r\n        attrs: { id: containerId, 'data-app-name': this.appName },\r\n      });\r\n    },\r\n  });\r\n};\r\n"],"names":["MicroAppLoader","this","start","qiankunStartOptions","_started","_addApp","manifest","name","idx","_appList","findIndex","it","splice","console","warn","push","addApp","forEach","_this","_findAppByName","find","getProps","keys","db","reduce","data","key","findApp","loadApp","containerId","propDb","config","container","props","propKeys","loadMicroApp","microAppLoader","loader","getPropDataSet","opt","autoRemove","Vue","extend","appInstance","errorMessage","computed","appName","mounted","log","app","beforeDestroy","unmount","render","h","attrs","id","data-app-name"],"mappings":"olBAkBaA,aAAb,aACUC,eAAW,EACXA,cAA0B,GAFpC,2BAOEC,MAAA,SAAMC,YAAAA,IAAAA,EAAqD,MACrDF,KAAKG,WAILD,EACFD,QAAMC,GAEND,UAEFD,KAAKG,UAAW,MAGVC,QAAA,SAAQC,GACd,IAAMC,EAAOD,EAASC,KAChBC,EAAMP,KAAKQ,SAASC,UAAU,SAACC,UAAOA,EAAGJ,OAASA,KAC3C,IAATC,GAKJP,KAAKQ,SAASG,OAAOJ,EAAK,EAAGF,GAC7BO,QAAQC,uDAAuDP,QAL7DN,KAAKQ,SAASM,KAAKT,MAYvBU,OAAA,sBACE,yBAAUC,QAAQ,SAACN,UAAOO,EAAKb,QAAQM,QAGjCQ,eAAA,SAAeZ,GACrB,YAAYE,SAASW,KAAK,SAACT,UAAOA,EAAGJ,OAASA,OAGxCc,SAAA,SAASC,EAAgBC,GAC/B,OAAOD,EAAKE,OAAO,SAACC,EAAMC,GAExB,OADAD,EAAKC,GAAOH,EAAGG,GACRD,GACN,OAOLE,QAAA,SAAQpB,GACN,YAAYY,eAAeZ,MAS7BqB,QAAA,SAAQtB,EAAuBuB,EAAqBC,GAClD,IAAMC,OACDzB,GACH0B,UAAWH,EACXI,MAAOhC,KAAKoB,SAASf,EAAS4B,UAAY,GAAIJ,KAGhD,OAAOK,eAAcJ,SAIZK,EAAiB,IAAIpC,+CAUK,SACrCqC,EACAC,mBACI/B,EAAcgC,YAAAA,IAAAA,EAAM,CAAEC,YAAY,IACtC,IAAMX,mBAA+BtB,EACrC,OAAOkC,UAAIC,OAAO,CAChBjB,gBACE,MAAO,CACLnB,SAAU,KACVqC,YAAa,KACbC,aAAc,KAGlBC,SAAU,CACRC,mBACE,YAAaxC,UAAYL,KAAKK,SAASC,MAAS,WAGpDwC,mBACElC,QAAQmC,IAAI,2CAA4CnB,GACxD,IAAMoB,EAAMZ,EAAOV,QAAQpB,GAC3B,GAAI0C,EAAK,CACP,IAAMnB,EAASQ,IACfrC,KAAK0C,YAAcN,EAAOT,QAAQqB,MAASpB,EAAeC,QAE1D7B,KAAK2C,aAAe,yBAA2BrC,GAGnD2C,yCACqBX,EAAIC,iBAELvC,KAAK0C,aAAmD,wBAAxBA,YAAYQ,SAC5DlD,KAAK0C,YAAYQ,WAGrBC,gBAAOC,GACL,OACSA,EAAE,MADe,KAAtBpD,KAAK2C,aACS3C,KAAK2C,aAGP,CACdU,MAAO,CAAEC,GAAI1B,EAAa2B,gBAAiBvD,KAAK6C"}